{% extends "base.html" %}

{% block title %}Stride Dashboard - Activity Details{% endblock %}
{% block page_title %}Activity Details{% endblock %}

{% block content %}
<style>
    .activity-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .summary-card {
        background: #f5f7fa;
        border-radius: 12px;
        padding: 1.5rem;
        border-left: 4px solid #4e73df;
    }

    .summary-card.primary {
        border-left-color: #4e73df;
    }

    .summary-card.info {
        border-left-color: #36a2eb;
    }

    .summary-card.success {
        border-left-color: #2ecc71;
    }

    .summary-card.warning {
        border-left-color: #f39c12;
    }

    .summary-card.danger {
        border-left-color: #e74c3c;
    }

    .summary-label {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    .summary-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #2c3e50;
    }

    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .chart-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #2c3e50;
    }

    .chart-wrapper {
        position: relative;
        height: 400px;
    }

    .zone-bar {
        display: flex;
        height: 12px;
        border-radius: 999px;
        overflow: hidden;
        background: #f3f3f3;
        margin-top: 1rem;
    }

    .zone-seg {
        height: 100%;
    }

    .zone-1 {
        background: rgba(78, 115, 223, 0.75);
    }

    .zone-2 {
        background: rgba(54, 162, 235, 0.75);
    }

    .zone-3 {
        background: rgba(46, 204, 113, 0.80);
    }

    .zone-4 {
        background: rgba(243, 156, 18, 0.80);
    }

    .zone-5 {
        background: rgba(231, 76, 60, 0.80);
    }

    .zone-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1rem;
        font-size: 0.9rem;
    }

    .zone-legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .zone-legend-color {
        width: 16px;
        height: 16px;
        border-radius: 4px;
    }

    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #e74c3c;
    }
</style>

<div id="activitySummary" style="margin-bottom: 2rem;">
    <p class="has-text-grey">Loading activity details…</p>
</div>

<div id="chartsContainer">
    <!-- HR vs Pace Chart -->
    <div class="chart-container">
        <div class="chart-title">Heart Rate vs Pace</div>
        <div class="chart-wrapper">
            <canvas id="hrPaceChart"></canvas>
        </div>
        <div class="zone-legend" id="zoneLegend"></div>
    </div>

    <!-- Elevation Chart -->
    <div class="chart-container">
        <div class="chart-title">Elevation Profile</div>
        <div class="chart-wrapper">
            <canvas id="elevationChart"></canvas>
        </div>
    </div>
</div>

<div id="errorContainer"></div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script>
    const ACTIVITY_ID = {{ activity_id }};

    const activitySummary = document.getElementById("activitySummary");
    const chartsContainer = document.getElementById("chartsContainer");
    const errorContainer = document.getElementById("errorContainer");
    const hrPaceCanvasEl = document.getElementById("hrPaceChart");
    const elevationCanvasEl = document.getElementById("elevationChart");

    let hrPaceChart = null;
    let elevationChart = null;
    let hrZones = null;

    const zoneColors = {
        1: "#4e73df",  // Zone 1 - Light blue
        2: "#36a2eb",  // Zone 2 - Medium blue
        3: "#2ecc71",  // Zone 3 - Green
        4: "#f39c12",  // Zone 4 - Orange
        5: "#e74c3c",  // Zone 5 - Red
    };

    const zoneNames = {
        1: "Zone 1 (50-60%)",
        2: "Zone 2 (60-70%)",
        3: "Zone 3 (70-80%)",
        4: "Zone 4 (80-90%)",
        5: "Zone 5 (90-100%)",
    };

    function getHRZone(hr) {
        if (!hrZones || !Array.isArray(hrZones.zones)) return null;
        for (const zone of hrZones.zones) {
            if (hr >= zone.min_bpm && hr <= zone.max_bpm) {
                return zone.zone;
            }
        }
        return null;
    }

    function getZoneColor(zone) {
        return zoneColors[zone] || "#999";
    }

    function formatDuration(seconds) {
        const mins = Math.floor(seconds / 60);
        const hrs = Math.floor(mins / 60);
        const remMins = mins % 60;
        if (hrs > 0) {
            return `${hrs}h ${remMins}m`;
        }
        return `${mins}m`;
    }

    function formatDate(dateStr) {
        const d = new Date(dateStr);
        return d.toLocaleDateString(undefined, {
            month: "short",
            day: "numeric",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
        });
    }

    async function fetchActivityDetails() {
        try {
            const resp = await fetch(`/api/activities/details/${ACTIVITY_ID}`);
            if (!resp.ok) throw new Error(`Failed to fetch activity details: ${resp.status}`);
            return await resp.json();
        } catch (error) {
            console.error("Error fetching activity details:", error);
            throw error;
        }
    }

    async function fetchHRZones() {
        try {
            const resp = await fetch("/api/hr/zones");
            if (!resp.ok) throw new Error(`Failed to fetch HR zones: ${resp.status}`);
            return await resp.json();
        } catch (error) {
            console.error("Error fetching HR zones:", error);
            return null;
        }
    }

    function renderActivitySummary(data, activityInfo) {
        if (!data || !Array.isArray(data.series)) {
            activitySummary.innerHTML = '<div class="error-message">No activity data available</div>';
            return;
        }

        if (!activityInfo) {
            activitySummary.innerHTML = '<div class="error-message">No activity summary available</div>';
            return;
        }

        // Use summary data for distance, duration, and HR
        const totalDistance = (activityInfo.distance_m || 0) / 1000;
        const totalDuration = activityInfo.duration_s || 0;
        const avgHR = activityInfo.avg_hr_bpm || 0;
        const maxHR = activityInfo.max_hr_bpm || 0;

        // Find max altitude from series for elevation gain
        const maxAltitude = Math.max(...data.series.map(p => p.altitude || 0));
        const minAltitude = Math.min(...data.series.map(p => p.altitude || Infinity));
        const elevationGain = Math.max(0, maxAltitude - minAltitude);

        const summaryHTML = `
      <div style="margin-bottom: 1.5rem;">
        <h2 class="subtitle" style="margin-bottom: 0.5rem;">${activityInfo?.activity_name || "Activity"}</h2>
        <p class="has-text-grey">${formatDate(activityInfo?.start || new Date().toISOString())}</p>
      </div>

      <div class="activity-summary">
        <div class="summary-card primary">
          <div class="summary-label">Distance</div>
          <div class="summary-value">${totalDistance.toFixed(2)}</div>
          <div style="font-size: 0.9rem; color: #6c757d; margin-top: 0.5rem;">km</div>
        </div>

        <div class="summary-card info">
          <div class="summary-label">Duration</div>
          <div class="summary-value">${formatDuration(totalDuration)}</div>
        </div>

        <div class="summary-card success">
          <div class="summary-label">Average HR</div>
          <div class="summary-value">${Math.round(avgHR)}</div>
          <div style="font-size: 0.9rem; color: #6c757d; margin-top: 0.5rem;">bpm</div>
        </div>

        <div class="summary-card danger">
          <div class="summary-label">Max HR</div>
          <div class="summary-value">${Math.round(maxHR)}</div>
          <div style="font-size: 0.9rem; color: #6c757d; margin-top: 0.5rem;">bpm</div>
        </div>

        <div class="summary-card warning">
          <div class="summary-label">Pace</div>
          <div class="summary-value">${activityInfo?.pace_mn_per_km || "–"}</div>
          <div style="font-size: 0.9rem; color: #6c757d; margin-top: 0.5rem;">min/km</div>
        </div>

        <div class="summary-card">
          <div class="summary-label">Elevation Gain</div>
          <div class="summary-value">${Math.round(elevationGain)}</div>
          <div style="font-size: 0.9rem; color: #6c757d; margin-top: 0.5rem;">m</div>
        </div>
      </div>
    `;

        activitySummary.innerHTML = summaryHTML;
    }

    function renderZoneLegend() {
        const legendEl = document.getElementById("zoneLegend");
        if (!hrZones || !Array.isArray(hrZones.zones)) return;

        legendEl.innerHTML = hrZones.zones.map(zone => `
      <div class="zone-legend-item">
        <div class="zone-legend-color" style="background-color: ${getZoneColor(zone.zone)};"></div>
        <span>Zone ${zone.zone}: ${zone.min_bpm}-${zone.max_bpm} bpm</span>
      </div>
    `).join("");
    }

    function createHRPaceChart(data) {
        if (!Array.isArray(data.series)) return;

        // Filter points with distance > 0 and HR data
        const points = data.series.filter(p =>
            p.distance_m && p.distance_m > 0 && p.hr && p.hr > 0
        );

        if (points.length === 0) {
            hrPaceCanvasEl.parentElement.innerHTML = '<p class="has-text-grey">No HR data available</p>';
            return;
        }

        const distances = points.map(p => (p.distance_m / 1000).toFixed(2));
        const hrValues = points.map(p => p.hr);
        const paceValues = points.map(p => {
            if (p.pace_mn_per_km) {
                const parts = p.pace_mn_per_km.split(":");
                const mins = parseInt(parts[0]);
                const secs = parseInt(parts[1]);
                return (mins * 60 + secs) / 60; // Divide by 60 for chart
            }
            return 0;
        });

        // Create color array based on HR zones
        const backgroundColor = hrValues.map(hr => {
            const zone = getHRZone(hr);
            return getZoneColor(zone) + "40";  // Add transparency
        });

        const borderColor = hrValues.map(hr => {
            const zone = getHRZone(hr);
            return getZoneColor(zone);
        });

        if (hrPaceChart) {
            hrPaceChart.destroy();
        }

        // Plugin to draw HR zone background shading
        const zoneBackgroundPlugin = {
            id: 'zoneBackground',
            afterDatasetsDraw(chart) {
                const ctx = chart.ctx;
                const yScale = chart.scales.y;
                const chartArea = chart.chartArea;

                if (!hrZones || !Array.isArray(hrZones.zones)) return;

                hrZones.zones.forEach(zone => {
                    const minPixel = yScale.getPixelForValue(zone.min_bpm);
                    const maxPixel = yScale.getPixelForValue(zone.max_bpm);
                    const color = getZoneColor(zone.zone);

                    ctx.fillStyle = color + "15"; // Very light transparency
                    ctx.fillRect(chartArea.left, maxPixel, chartArea.width, minPixel - maxPixel);
                });
            }
        };

        hrPaceChart = new Chart(hrPaceCanvasEl, {
            type: "line",
            data: {
                labels: distances,
                datasets: [
                    {
                        label: "Heart Rate (bpm)",
                        data: hrValues,
                        borderColor: borderColor,
                        backgroundColor: backgroundColor,
                        borderWidth: 3,
                        pointRadius: 4,
                        pointBackgroundColor: borderColor,
                        pointBorderColor: "#fff",
                        pointBorderWidth: 2,
                        tension: 0.2,
                        yAxisID: "y",
                    },
                    {
                        label: "Pace (min/km)",
                        data: paceValues,
                        borderColor: "#6b4c96",
                        backgroundColor: "rgba(107, 76, 150, 0.15)",
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        tension: 0.2,
                        yAxisID: "y1",
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: "index",
                    intersect: false,
                },
                plugins: {
                    legend: {
                        display: true,
                        position: "top",
                    },
                    filler: {
                        propagate: true,
                    },
                    tooltip: {
                        propagate: true,
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                if (context.datasetIndex === 0) {
                                    const hr = context.parsed.y;
                                    return `Heart Rate: ${hr} bpm`;
                                } else if (context.datasetIndex === 1) {
                                    const pointIndex = context.dataIndex;
                                    const pace = points[pointIndex].pace_mn_per_km;
                                    return `Pace: ${pace}`;
                                }
                            },
                            afterLabel: function (context) {
                                if (context.datasetIndex === 0) {
                                    const hr = context.parsed.y;
                                    const zone = getHRZone(hr);
                                    return zone ? `Zone ${zone}` : "";
                                }
                            },
                        },
                    },
                },
                scales: {
                    y: {
                        type: "linear",
                        display: true,
                        position: "left",
                        title: {
                            display: true,
                            text: "Heart Rate (bpm)",
                            color: "#4e73df",
                        },
                        ticks: {
                            color: "#4e73df",
                        },
                        grid: {
                            color: "rgba(78, 115, 223, 0.1)",
                        },
                    },
                    y1: {
                        type: "linear",
                        display: true,
                        position: "right",
                        reverse: true,
                        title: {
                            display: true,
                            text: "Pace (min/km)",
                            color: "#8e7cc3",
                        },
                        ticks: {
                            color: "#8e7cc3",
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    },
                    x: {
                        title: {
                            display: true,
                            text: "Distance (km)",
                        },
                    },
                },
            },
            plugins: [zoneBackgroundPlugin],
        });
    }

    function createElevationChart(data) {
        if (!Array.isArray(data.series)) return;

        // Filter points with distance and altitude data
        const points = data.series.filter(p =>
            p.distance_m && p.distance_m > 0 && p.altitude != null
        );

        if (points.length === 0) {
            elevationCanvasEl.parentElement.innerHTML = '<p class="has-text-grey">No elevation data available</p>';
            return;
        }

        const distances = points.map(p => (p.distance_m / 1000).toFixed(2));
        const altitudes = points.map(p => Math.round(p.altitude));

        if (elevationChart) {
            elevationChart.destroy();
        }

        elevationChart = new Chart(elevationCanvasEl, {
            type: "line",
            data: {
                labels: distances,
                datasets: [
                    {
                        label: "Altitude (m)",
                        data: altitudes,
                        borderColor: "#36a2eb",
                        backgroundColor: "rgba(54, 162, 235, 0.1)",
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 2,
                        pointBackgroundColor: "#36a2eb",
                        tension: 0.2,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: "index",
                    intersect: false,
                },
                plugins: {
                    legend: {
                        display: true,
                        position: "top",
                    },
                },
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: "Altitude (m)",
                        },
                    },
                    x: {
                        title: {
                            display: true,
                            text: "Distance (km)",
                        },
                    },
                },
            },
        });
    }

    async function initPage() {
        try {
            // Fetch data in parallel
            const [activityData, zones, activityInfo] = await Promise.all([
                fetchActivityDetails(),
                fetchHRZones(),
                fetch(`/api/activities/${ACTIVITY_ID}`)
                    .then(r => r.json())
                    .then(d => d.activity),
            ]);

            hrZones = zones;

            // Render summary
            renderActivitySummary(activityData, activityInfo);

            // Render zone legend
            renderZoneLegend();

            // Create charts
            createHRPaceChart(activityData);
            createElevationChart(activityData);

        } catch (error) {
            console.error("Error initializing page:", error);
            errorContainer.innerHTML = `
        <div class="error-message">
          <strong>Error:</strong> ${error.message}
        </div>
      `;
        }
    }

    window.addEventListener("DOMContentLoaded", initPage);
</script>
{% endblock %}
